schemaName: dbops_proxy

dataSources:
  ds_trade:
    url: jdbc:mysql://host.docker.internal:3306/corp_trade_center?serverTimezone=UTC&useSSL=false
    username: root
    password: 2679622408
    connectionTimeoutMilliseconds: 30000
    idleTimeoutMilliseconds: 60000
    maxPoolSize: 50
  ds_user:
    url: jdbc:mysql://host.docker.internal:3306/corp_user_center?serverTimezone=UTC&useSSL=false
    username: root
    password: 2679622408
    maxPoolSize: 50
  ds_scm:
    url: jdbc:mysql://host.docker.internal:3306/corp_scm_erp?serverTimezone=UTC&useSSL=false
    username: root
    password: 2679622408
    maxPoolSize: 50
  ds_mkt:
    url: jdbc:mysql://host.docker.internal:3306/corp_marketing?serverTimezone=UTC&useSSL=false
    username: root
    password: 2679622408
    maxPoolSize: 50
  ds_log:
    url: jdbc:mysql://host.docker.internal:3306/corp_data_log?serverTimezone=UTC&useSSL=false
    username: root
    password: 2679622408
    maxPoolSize: 50

rules:
  - !SHARDING
    tables:
      # ==========================================
      # 1. æ ¸å¿ƒä¸šåŠ¡è¡¨ (ä¿æŒä½ åŽŸæœ‰çš„ä¸å˜)
      # ==========================================
      t_order:
        actualDataNodes: ds_trade.t_order_$->{(0..127).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: oid
            shardingAlgorithmName: t_order_inline
        keyGenerateStrategy:
          column: oid
          keyGeneratorName: snowflake

      t_order_item:
        actualDataNodes: ds_trade.t_order_item_$->{(0..127).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: oid
            shardingAlgorithmName: t_order_inline
        keyGenerateStrategy:
          column: id
          keyGeneratorName: snowflake

      t_pay_flow:
        actualDataNodes: ds_trade.t_pay_flow_$->{(0..127).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: oid
            shardingAlgorithmName: t_pay_flow_inline

      u_user_base:
        actualDataNodes: ds_user.u_user_base_$->{(0..63).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: uid
            shardingAlgorithmName: u_user_inline
        keyGenerateStrategy:
          column: uid
          keyGeneratorName: snowflake

      u_login_log:
        actualDataNodes: ds_user.u_login_log_$->{(0..63).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: uid
            shardingAlgorithmName: u_login_inline
        keyGenerateStrategy:
          column: id
          keyGeneratorName: snowflake

      log_api_access:
        actualDataNodes: ds_log.log_api_access_2025W$->{(1..104).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: id
            shardingAlgorithmName: log_week_inline_access
        keyGenerateStrategy:
          column: id
          keyGeneratorName: snowflake

      log_err_report:
        actualDataNodes: ds_log.log_err_report_2025W$->{(1..104).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: id
            shardingAlgorithmName: log_week_inline_err
        keyGenerateStrategy:
          column: id
          keyGeneratorName: snowflake

      # ==========================================
      # 2. ðŸ”¥ ç¼ºå¤±çš„ç»´è¡¨è§„åˆ™ (å¯¹åº” Python add_dim_tables) ðŸ”¥
      # ==========================================
      # è¿™äº›è¡¨åœ¨ Python é‡Œæ˜¯ 0-49 åˆ†ç‰‡ï¼Œå¿…é¡»æ˜¾å¼é…ç½®ï¼Œå¦åˆ™ Agent æŸ¥ä¸åˆ°é€»è¾‘è¡¨å

      # [äº¤æ˜“ä¸­å¿ƒ] trade_dim (000-049)
      trade_dim:
        actualDataNodes: ds_trade.trade_dim_$->{(0..49).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: id
            shardingAlgorithmName: trade_dim_inline

      # [ç”¨æˆ·ä¸­å¿ƒ] user_dim (000-049) -> è§£å†³ä½ åˆšæ‰æŠ¥é”™ user_dim missing çš„é—®é¢˜
      user_dim:
        actualDataNodes: ds_user.user_dim_$->{(0..49).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: id
            shardingAlgorithmName: user_dim_inline

      # [ä¾›åº”é“¾] scm_dim (000-049)
      scm_dim:
        actualDataNodes: ds_scm.scm_dim_$->{(0..49).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: id
            shardingAlgorithmName: scm_dim_inline

      # [è¥é”€ä¸­å¿ƒ] mkt_dim (000-049)
      mkt_dim:
        actualDataNodes: ds_mkt.mkt_dim_$->{(0..49).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: id
            shardingAlgorithmName: mkt_dim_inline

      # [æ—¥å¿—ä¸­å¿ƒ] log_dim (000-049)
      log_dim:
        actualDataNodes: ds_log.log_dim_$->{(0..49).collect{it.toString().padLeft(3,'0')}}
        tableStrategy:
          standard:
            shardingColumn: id
            shardingAlgorithmName: log_dim_inline

    # ==========================================
    # 3. ç®—æ³•å®šä¹‰
    # ==========================================
    shardingAlgorithms:
      # æ ¸å¿ƒè¡¨ç®—æ³•
      t_order_inline:
        type: INLINE
        props:
          algorithm-expression: t_order_${(oid % 128).toString().padLeft(3,'0')}
      t_pay_flow_inline:
        type: INLINE
        props:
          algorithm-expression: t_pay_flow_${(oid % 128).toString().padLeft(3,'0')}
      u_user_inline:
        type: INLINE
        props:
          algorithm-expression: u_user_base_${(uid % 64).toString().padLeft(3,'0')}
      u_login_inline:
        type: INLINE
        props:
          algorithm-expression: u_login_log_${(uid % 64).toString().padLeft(3,'0')}
      log_week_inline_access:
        type: INLINE
        props:
          algorithm-expression: log_api_access_2025W${(id % 104 + 1).toString().padLeft(3,'0')}
      log_week_inline_err:
        type: INLINE
        props:
          algorithm-expression: log_err_report_2025W${(id % 104 + 1).toString().padLeft(3,'0')}

      # ðŸ”¥ðŸ”¥ðŸ”¥ æ–°å¢žï¼šç»´è¡¨ç®—æ³• (å…¨éƒ¨æ¨¡ 50) ðŸ”¥ðŸ”¥ðŸ”¥
      trade_dim_inline:
        type: INLINE
        props:
          algorithm-expression: trade_dim_${(id % 50).toString().padLeft(3,'0')}
      user_dim_inline:
        type: INLINE
        props:
          algorithm-expression: user_dim_${(id % 50).toString().padLeft(3,'0')}
      scm_dim_inline:
        type: INLINE
        props:
          algorithm-expression: scm_dim_${(id % 50).toString().padLeft(3,'0')}
      mkt_dim_inline:
        type: INLINE
        props:
          algorithm-expression: mkt_dim_${(id % 50).toString().padLeft(3,'0')}
      log_dim_inline:
        type: INLINE
        props:
          algorithm-expression: log_dim_${(id % 50).toString().padLeft(3,'0')}

    keyGenerators:
      snowflake:
        type: SNOWFLAKE