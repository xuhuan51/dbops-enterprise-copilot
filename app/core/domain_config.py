# app/core/domain_config.py
from typing import List, Dict

# ==========================================
# ğŸ§  åŸå­åŒ–è§„åˆ™åº“ (Atomic Rule Base)
# ==========================================
# æ¯ä¸€æ¡è§„åˆ™éƒ½æœ‰ trigger keywordsï¼Œå‘½ä¸­æ‰åŠ è½½
ALL_RULES = [
    # --- é’ˆå¯¹ Test 4: åº“å­˜æ¼å…³è” Sku ---
    {
        "id": "stock_detail",
        "keywords": ["SkuID", "SKU", "å•†å“åç§°", "è§„æ ¼", "ä»€ä¹ˆå•†å“"],
        "content": "æŸ¥è¯¢åº“å­˜çš„å…·ä½“å•†å“ä¿¡æ¯ï¼ˆå¦‚åç§°/è§„æ ¼/IDï¼‰æ—¶ï¼Œé™¤äº† `scm_stock` (åº“å­˜æ•°)ï¼Œ**å¿…é¡»**å…³è” `scm_sku` (å•†å“åŸºç¡€ä¿¡æ¯)ã€‚"
    },

    # --- é’ˆå¯¹ Test 9: åœ°åŒºç»Ÿè®¡æ¼ User ---
    {
        "id": "region_analysis",
        "keywords": ["åŒ—äº¬", "ä¸Šæµ·", "åœ°åŒº", "åŸå¸‚", "ä½å€", "å“ªé‡Œ"],
        "content": "æ¶‰åŠâ€œåœ°åŒº/åŸå¸‚/åœ°åŸŸâ€ç»´åº¦çš„ç»Ÿè®¡ï¼Œè®¢å•è¡¨é€šå¸¸ä¸å«åœ°å€è¯¦æƒ…ï¼Œ**å¿…é¡»**å…³è” `u_user_base` æˆ– `u_user_address`ã€‚"
    },

    # --- é’ˆå¯¹ Test 11: ä¾›åº”å•†é€€è´§ vs å®¢æˆ·é€€è´§ ---
    {
        "id": "return_b_side",
        "keywords": ["ä¾›åº”å•†", "é‡‡è´­", "è¿›è´§", "å‚å®¶", "Bç«¯", "è´¨é‡é—®é¢˜"],
        "content": "æåˆ°â€œé€€ç»™ä¾›åº”å•†â€æˆ–â€œé‡‡è´­é€€è´§â€ï¼Œ**å¿…é¡»**é€‰ `scm_purchase_return` (Bç«¯ä¸šåŠ¡)ï¼Œ**ä¸¥ç¦**é€‰ `t_after_sale` (Cç«¯å®¢æˆ·å”®å)ã€‚"
    },
    {
        "id": "return_c_side",
        "keywords": ["å®¢æˆ·", "ç”¨æˆ·", "ä¹°å®¶", "å”®å", "é€€æ¬¾", "ä¸ƒå¤©"],
        "content": "æåˆ°â€œå®¢æˆ·é€€è´§â€æˆ–â€œå”®åç”³è¯·â€ï¼Œ**å¿…é¡»**é€‰ `t_after_sale` (Cç«¯ä¸šåŠ¡)ã€‚"
    },

    # --- é’ˆå¯¹ Test 12: ç›´æ’­æ‹‰æ–° (æ³¨å†Œé‡ vs é”€é‡) ---
    {
        "id": "user_acquisition",
        "keywords": ["æ–°ç”¨æˆ·", "æ³¨å†Œ", "æ‹‰æ–°", "æ–°å¢"],
        "content": "ç»Ÿè®¡â€œæ–°ç”¨æˆ·æ³¨å†Œé‡â€æ—¶ï¼Œæ ¸å¿ƒè¡¨æ˜¯ `u_user_base` (æŸ¥çœ‹ create_time)ï¼Œ**ä¸è¦**åªæŸ¥ä¸šåŠ¡æ´»åŠ¨è¡¨æˆ–è®¢å•è¡¨ã€‚"
    },

    # --- é€šç”¨å…œåº•è§„åˆ™ ---
    {
        "id": "safety_check",
        "keywords": ["å·¥èµ„", "è–ªèµ„", "åº•è–ª", "å†™è¯—", "å¤©æ°”", "ä½ å¥½"],
        "content": "éæ•°æ®åˆ†æç±»è¯·æ±‚ï¼ˆé—²èŠ/åˆ›ä½œï¼‰æˆ–æ•æ„Ÿäººäº‹æŸ¥è¯¢ï¼ˆæŸ¥å·¥èµ„ï¼‰ï¼Œç›´æ¥è¿”å› ASK_USERã€‚"
    },
    {
        "id": "core_business",
        "keywords": ["GMV", "è¥æ”¶", "äº¤æ˜“", "å–äº†", "è®¢å•"],
        "content": "æ¶‰åŠäº¤æ˜“é‡‘é¢/GMVæ—¶ï¼Œä¼˜å…ˆé€‰ `t_order` æˆ– `t_pay_flow`ï¼Œä¸è¦é€‰åº“å­˜è¡¨ã€‚"
    }
]

# ==========================================
# ğŸ“š å›ºå®šèŒƒä¾‹ (Few-Shot) - ä¿æŒç²¾ç®€
# ==========================================
ECOMMERCE_EXAMPLES = """
### èŒƒä¾‹ 1ï¼šBç«¯é€€è´§æ­§ä¹‰
User: "æŸ¥çœ‹å› ä¸ºè´¨é‡é—®é¢˜é€€ç»™ä¾›åº”å•†çš„è®°å½•"
Candidates: ["t_after_sale", "scm_purchase_return", "scm_supplier_base"]
Thinking: å…³é”®è¯"ä¾›åº”å•†"ã€"é€€ç»™" -> Bç«¯é‡‡è´­é€€è´§ã€‚t_after_sale æ˜¯Cç«¯ -> å‰”é™¤ã€‚
Output: {"status": "PASS", "selected_tables": ["scm_purchase_return", "scm_supplier_base"]}

### èŒƒä¾‹ 2ï¼šåœ°åŒºç»´åº¦ç¼ºå¤±
User: "åŒ—äº¬åœ°åŒºç”¨æˆ·çš„è®¢å•é‡"
Candidates: ["t_order", "scm_stock"]
Thinking: t_order ç¼ºåœ°åŒºå­—æ®µã€‚éœ€è¦è¡¥å…¨ç”¨æˆ·è¡¨ã€‚
Output: {"status": "COMPLEMENT", "reason": "ç¼ºå°‘ç”¨æˆ·åœ°åŒºè¡¨", "search_keywords": ["u_user_base"]}

### èŒƒä¾‹ 3ï¼šåº“å­˜è¯¦æƒ…å…³è”
User: "æŸ¥SkuID=888çš„åº“å­˜å’Œåç§°"
Candidates: ["scm_stock", "t_order"]
Thinking: æŸ¥åº“å­˜ -> scm_stockã€‚è¦åç§° -> ç¼º scm_skuã€‚t_order æ— å…³ -> å‰”é™¤ã€‚
Output: {"status": "COMPLEMENT", "reason": "éœ€è¦è¡¥å…¨å•†å“ä¿¡æ¯è¡¨", "search_keywords": ["scm_sku"]}
"""


# ==========================================
# ğŸš€ æ™ºèƒ½é€‰æ‹©å™¨ (Smart Selector)
# ==========================================
def get_relevant_rules(query: str) -> str:
    """
    æ ¹æ®ç”¨æˆ· Queryï¼ŒåŠ¨æ€è®¡ç®—æœ€åŒ¹é…çš„ä¸šåŠ¡è§„åˆ™ã€‚
    """
    selected_contents = []
    query_lower = query.lower()

    # 1. å‘½ä¸­é€»è¾‘ï¼šåªè¦ Query åŒ…å«è§„åˆ™é‡Œçš„ä»»ä¸€å…³é”®è¯ï¼Œå°±åŠ è½½è¯¥è§„åˆ™
    for rule in ALL_RULES:
        if any(kw.lower() in query_lower for kw in rule["keywords"]):
            selected_contents.append(f"- {rule['content']}")

    # 2. å¦‚æœä¸€æ¡éƒ½æ²¡å‘½ä¸­ï¼ŒåŠ è½½é»˜è®¤è§„åˆ™ (é˜²æ­¢ LLM è£¸å¥”)
    if not selected_contents:
        selected_contents.append("- ä¼˜å…ˆé€‰æ‹©è¡¨åä¸é—®é¢˜å…³é”®è¯è¯­ä¹‰æœ€åŒ¹é…çš„è¡¨ã€‚")
        selected_contents.append("- æ¶‰åŠè·¨åŸŸæŸ¥è¯¢æ—¶ï¼ˆå¦‚è®¢å•+ç”¨æˆ·ï¼‰ï¼Œç¡®ä¿é€‰ä¸­äº†æ‰€æœ‰å¿…è¦çš„ç»´åº¦è¡¨ã€‚")

    return "\n".join(selected_contents)